import{p as ye,a4 as C,o as V,c as U,b as e,w as t,V as H,u as d,ap as Ve,d as f,aw as _e,f as P,k as B,a as j,H as we,ax as Te,ay as Ce,N as xe,az as be,P as Se,aA as Re,aB as he,Q as De,a2 as Ae,aC as Ie,a3 as Pe,U as Be,aD as Le,a0 as Me,v as ne,aE as $e,D as Ue,z as le,y as pe,aF as Ne,s as Q,a7 as Ee,aG as se,aH as Fe,aI as Oe,a8 as Ye,m as ue,aJ as je,G as He,E as ze,ab as Ke,ao as te,aK as Xe,aL as qe,t as v,F as G,l as ie,aM as ae,am as Ge,aq as re}from"./index-CdBy1DAC.js";import{e as ce,c as O,b as Je,a as J,i as Qe,j as We,k as de,A as Ze,h as et,f as tt,g as at}from"./injection-BTu2Ks4h.js";import{d as M}from"./amountHelper-DpIpIitT.js";import{V as nt,c as lt,b as ot,d as st,_ as ut,e as it,f as rt,g as ke,k as ct,j as dt,S as me}from"./VToolbarItems-C77m-ae0.js";import{a as oe,b as mt,R,c as ft,d as fe}from"./dbContext-BF5vDBMi.js";import{S as ge}from"./sweetalert2.esm.all-BGf-Fe8G.js";import{e as ve}from"./eventBus-E5P-NQ8u.js";import{V as Y,a as p}from"./VRow-CPz841Jz.js";import"./recordCategory-CURYKHIw.js";import"./VSelect-D4EjrY1s.js";import"./VSlideGroup-Bj1dRMNG.js";import"./VTabs-DmUrWeoB.js";import"./plugin-vueexport-helper-DlAUqK2U.js";function vt(s,r){if(r){const u=new Map;for(const l of s){const g=r(l);u.has(g)||u.set(g,l)}return Array.from(u.values())}else return Array.from(new Set(s))}const yt={class:"text-center"},pt={class:"w-100 mt-auto"},kt=ye({__name:"EditRecordDialog",props:{accounts:{}},emits:["onSave","onDelete"],setup(s,{expose:r,emit:u}){const l=C(ft.getNewSpendRecord(void 0,void 0));r({openDialog:x});const g=C(!1),D=u;async function A(){l.value&&D("onSave",l.value),g.value=!1}async function _(){(await ge.fire({title:"你確定要刪除此筆紀錄嗎？",text:"此動作無法還原，請三思。",icon:"warning",showCancelButton:!0,confirmButtonText:"刪除",cancelButtonText:"取消"})).isConfirmed&&(D("onDelete",l.value),g.value=!1)}function x(w){l.value={...w},g.value=!0}return(w,c)=>(V(),U("div",yt,[e(ke,{modelValue:g.value,"onUpdate:modelValue":c[4]||(c[4]=y=>g.value=y),fullscreen:"",transition:"dialog-bottom-transition"},{default:t(()=>[e(oe,{rounded:!1},{default:t(()=>[e(nt,{dark:"",color:"primary",style:{flex:"unset"}},{default:t(()=>[e(H,{icon:"",color:"inherit",onClick:c[0]||(c[0]=y=>g.value=!1),flat:""},{default:t(()=>[e(d(Ve),{width:"20"})]),_:1}),e(lt,null,{default:t(()=>c[5]||(c[5]=[f("編輯記錄")])),_:1}),e(ot),e(st,null,{default:t(()=>[e(H,{icon:"",color:"inherit",onClick:_},{default:t(()=>[e(d(_e))]),_:1})]),_:1})]),_:1}),e(mt,null,{default:t(()=>[l.value.recordType==d(R).Spend?(V(),P(ut,{key:0,modelValue:l.value,"onUpdate:modelValue":c[1]||(c[1]=y=>l.value=y),accounts:w.accounts},null,8,["modelValue","accounts"])):B("",!0),l.value.recordType==d(R).Income?(V(),P(it,{key:1,modelValue:l.value,"onUpdate:modelValue":c[2]||(c[2]=y=>l.value=y),accounts:w.accounts},null,8,["modelValue","accounts"])):B("",!0),l.value.recordType==d(R).Transfer?(V(),P(rt,{key:2,modelValue:l.value,"onUpdate:modelValue":c[3]||(c[3]=y=>l.value=y),accounts:w.accounts},null,8,["modelValue","accounts"])):B("",!0)]),_:1}),j("div",pt,[e(H,{color:"primary rounded-0",class:"w-100 h-100 py-4",onClick:A},{default:t(()=>c[6]||(c[6]=[f("儲存")])),_:1})])]),_:1})]),_:1},8,["modelValue"])]))}});function gt(s){const r=ne(s());let u=-1;function l(){clearInterval(u)}function g(){l(),Ke(()=>r.value=s())}function D(A){const _=A?getComputedStyle(A):{transitionDuration:.2},x=parseFloat(_.transitionDuration)*1e3||200;if(l(),r.value<=0)return;const w=performance.now();u=window.setInterval(()=>{const c=performance.now()-w+x;r.value=Math.max(s()-c,0),r.value<=0&&l()},x)}return He(l),{clear:l,time:r,start:D,reset:g}}const Vt=we({multiLine:Boolean,text:String,timer:[Boolean,String],timeout:{type:[Number,String],default:5e3},vertical:Boolean,...Te({location:"bottom"}),...Ce(),...xe(),...be(),...Se(),...Re(he({transition:"v-snackbar-transition"}),["persistent","noClickAnimation","scrim","scrollStrategy"])},"VSnackbar"),_t=De()({name:"VSnackbar",props:Vt(),emits:{"update:modelValue":s=>!0},setup(s,r){let{slots:u}=r;const l=Ae(s,"modelValue"),{positionClasses:g}=Ie(s),{scopeId:D}=Pe(),{themeClasses:A}=Be(s),{colorClasses:_,colorStyles:x,variantClasses:w}=Le(s),{roundedClasses:c}=Me(s),y=gt(()=>Number(s.timeout)),z=C(),h=C(),b=ne(!1),I=ne(0),N=C(),W=$e(ct,void 0);Ue(()=>!!W,()=>{const k=dt();ze(()=>{N.value=k.mainStyles.value})}),le(l,L),le(()=>s.timeout,L),pe(()=>{l.value&&L()});let $=-1;function L(){y.reset(),window.clearTimeout($);const k=Number(s.timeout);if(!l.value||k===-1)return;const n=Ne(h.value);y.start(n),$=window.setTimeout(()=>{l.value=!1},k)}function K(){y.reset(),window.clearTimeout($)}function X(){b.value=!0,K()}function E(){b.value=!1,L()}function F(k){I.value=k.touches[0].clientY}function Z(k){Math.abs(I.value-k.changedTouches[0].clientY)>50&&(l.value=!1)}function ee(){b.value&&E()}const q=Q(()=>s.location.split(" ").reduce((k,n)=>(k[`v-snackbar--${n}`]=!0,k),{}));return Ee(()=>{const k=se.filterProps(s),n=!!(u.default||u.text||s.text);return e(se,ue({ref:z,class:["v-snackbar",{"v-snackbar--active":l.value,"v-snackbar--multi-line":s.multiLine&&!s.vertical,"v-snackbar--timer":!!s.timer,"v-snackbar--vertical":s.vertical},q.value,g.value,s.class],style:[N.value,s.style]},k,{modelValue:l.value,"onUpdate:modelValue":a=>l.value=a,contentProps:ue({class:["v-snackbar__wrapper",A.value,_.value,c.value,w.value],style:[x.value],onPointerenter:X,onPointerleave:E},k.contentProps),persistent:!0,noClickAnimation:!0,scrim:!1,scrollStrategy:"none",_disableGlobalStack:!0,onTouchstartPassive:F,onTouchend:Z,onAfterLeave:ee},D),{default:()=>{var a,o;return[Fe(!1,"v-snackbar"),s.timer&&!b.value&&e("div",{key:"timer",class:"v-snackbar__timer"},[e(Oe,{ref:h,color:typeof s.timer=="string"?s.timer:"info",max:s.timeout,"model-value":y.time.value},null)]),n&&e("div",{key:"content",class:"v-snackbar__content",role:"status","aria-live":"polite"},[((a=u.text)==null?void 0:a.call(u))??s.text,(o=u.default)==null?void 0:o.call(u)]),u.actions&&e(Ye,{defaults:{VBtn:{variant:"text",ripple:!1,slim:!0}}},{default:()=>[e("div",{class:"v-snackbar__actions"},[u.actions({isActive:l})])]})]},activator:u.activator})}),je({},z)}}),wt={class:"py-3"},Tt=["onContextmenu"],$t=ye({__name:"ListPage",async setup(s){let r,u;C({title:"紀錄管理"});const l=et(),g=tt(),D=([r,u]=te(()=>g.getAllAsync()),r=await r,u(),r),A=at(),_=([r,u]=te(()=>A.getAllAsync()),r=await r,u(),r),x=C(!1),w=C(""),c=C(!1),y=C(void 0);function z(n){y.value=n,c.value=!0}const h=C(new Date),b=C(([r,u]=te(()=>l.getMonthRecordsAsync(h.value)),r=await r,u(),r));le(h,I);async function I(){b.value=await l.getMonthRecordsAsync(h.value)}const N=Q(()=>vt(b.value.map(a=>We(a.dateTime)),a=>a.getTime()).sort((a,o)=>o.getTime()-a.getTime()).map(a=>({date:a,records:b.value.filter(o=>de(o.dateTime,a)).sort((o,T)=>((T==null?void 0:T.id)??0)-((o==null?void 0:o.id)??0)),total:b.value.filter(o=>de(o.dateTime,a)).sort((o,T)=>((T==null?void 0:T.id)??0)-((o==null?void 0:o.id)??0)).map(o=>W(o)).reduce((o,T)=>o+T)})));function W(n){let a=0;switch(n.recordType){case R.Spend:a=-1;break;case R.Income:a=1;break;case R.Transfer:a=0;break}return n.amount*a}function $(n){w.value=n,x.value=!0}function L(n){h.value=Ze(h.value,n)}const K=Q(()=>b.value.filter(n=>n.recordType==R.Spend).map(n=>n.amount).reduce((n,a)=>n+a,0)),X=Q(()=>b.value.filter(n=>n.recordType==R.Income).map(n=>n.amount).reduce((n,a)=>n+a,0)),E=Xe("editRecordDialog");function F(n){if(!_.some(a=>a.id==n.accountId)||n.toAccountId!=null&&!_.some(a=>a.id==n.toAccountId)){$("相關帳號已被銷毀，無法編輯。");return}E.value.openDialog(n)}async function Z(n){await new me().onRecordUpdatingAsync(re(n)),await l.updateAsync(re(n)),I()}async function ee(){var n;if(c.value=!1,(n=y==null?void 0:y.value)!=null&&n.id){if(!(await ge.fire({title:"你確定要刪除此筆紀錄嗎？",text:"此動作無法還原，請三思。",icon:"warning",showCancelButton:!0,confirmButtonText:"刪除",cancelButtonText:"取消"})).isConfirmed)return;q(y.value)}}async function q(n){await l.removeAsync(n.id),await new me().onRecordRemovedAsync(n),I(),$("已刪除一筆紀錄。")}function k(n){n!=null&&n.id&&q(n)}return pe(()=>ve.on("any-record-change",I)),qe(()=>ve.off("any-record-change",I)),(n,a)=>(V(),U(G,null,[e(oe,{elevation:"10"},{default:t(()=>[e(fe,{class:"text-white bg-primary pb-4"},{default:t(()=>[e(Y,null,{default:t(()=>[e(p,{cols:"3",class:"text-start py-0"},{default:t(()=>[e(H,{variant:"flat",color:"primary",onClick:a[0]||(a[0]=o=>L(-1)),icon:"mdi-menu-left"})]),_:1}),e(p,{cols:"6",class:"text-center py-0"},{default:t(()=>[j("h2",wt,v(h.value.getFullYear())+" 年 "+v(h.value.getMonth()+1)+" 月",1)]),_:1}),e(p,{cols:"3",class:"text-end py-0"},{default:t(()=>[e(H,{icon:"mdi-menu-right",variant:"flat",onClick:a[1]||(a[1]=o=>L(1)),color:"primary"})]),_:1})]),_:1}),e(Y,{class:"text-center"},{default:t(()=>[e(p,null,{default:t(()=>[a[6]||(a[6]=f(" 收入")),j("h2",null,v(d(M)(X.value)),1)]),_:1}),e(p,null,{default:t(()=>[a[7]||(a[7]=f(" 支出")),j("h2",null,v(d(M)(K.value)),1)]),_:1}),e(p,null,{default:t(()=>[a[8]||(a[8]=f(" 本月合計")),j("h2",null,v(d(M)(X.value-K.value)),1)]),_:1})]),_:1})]),_:1}),e(ce,{class:"pt-0"},{default:t(()=>[(V(!0),U(G,null,ie(N.value,(o,T)=>(V(),U(G,{key:o.date},[e(O,{class:"py-3"},{append:t(()=>[e(Je,{opacity:"100",class:"text-subtitle-1 font-weight-bold"},{default:t(()=>[f(v(o.total?d(M)(o.total):"0"),1)]),_:2},1024)]),default:t(()=>[e(J,{class:"text-subtitle-1 font-weight-bold"},{default:t(()=>[f(v(d(Qe)(o.date,"MM/DD (ddd)")),1)]),_:2},1024)]),_:2},1024),e(ae,{class:"border-opacity-75"}),(V(!0),U(G,null,ie(o.records,i=>(V(),U("div",{key:i.id,onContextmenu:Ge(m=>z(i),["prevent"])},[i.recordType==d(R).Spend?(V(),P(O,{key:0,class:"py-3",onClick:m=>F(i)},{default:t(()=>[e(J,{class:"text-medium-emphasis"},{default:t(()=>[e(Y,null,{default:t(()=>[e(p,{cols:"3"},{default:t(()=>{var m;return[f(v((m=d(_).find(S=>S.id==i.accountId))==null?void 0:m.name),1)]}),_:2},1024),e(p,{cols:"3"},{default:t(()=>{var m;return[f(v((m=d(D).find(S=>S.id==i.categoryId))==null?void 0:m.name),1)]}),_:2},1024),e(p,null,{default:t(()=>[f(v(i==null?void 0:i.memo),1)]),_:2},1024),e(p,{cols:"3",class:"text-end text-primary"},{default:t(()=>[f(v(d(M)(i.amount)),1)]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1032,["onClick"])):B("",!0),i.recordType==d(R).Income?(V(),P(O,{key:1,class:"py-3",onClick:m=>F(i)},{default:t(()=>[e(J,{class:"text-medium-emphasis"},{default:t(()=>[e(Y,null,{default:t(()=>[e(p,{cols:"3"},{default:t(()=>{var m;return[f(v((m=d(_).find(S=>S.id==i.accountId))==null?void 0:m.name),1)]}),_:2},1024),e(p,{cols:"3"},{default:t(()=>{var m;return[f(v((m=d(D).find(S=>S.id==i.categoryId))==null?void 0:m.name),1)]}),_:2},1024),e(p,null,{default:t(()=>[f(v(i==null?void 0:i.memo),1)]),_:2},1024),e(p,{cols:"3",class:"text-end text-secondary"},{default:t(()=>[f(v(d(M)(i.amount)),1)]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1032,["onClick"])):B("",!0),i.recordType==d(R).Transfer?(V(),P(O,{key:2,class:"py-3",onClick:m=>F(i)},{default:t(()=>[e(J,{class:"text-medium-emphasis"},{default:t(()=>[e(Y,null,{default:t(()=>[e(p,{cols:"3"},{default:t(()=>{var m;return[f(v((m=d(_).find(S=>S.id==i.accountId))==null?void 0:m.name),1)]}),_:2},1024),e(p,{cols:"3"},{default:t(()=>{var m;return[f("轉至"+v(((m=d(_).find(S=>S.id==i.toAccountId))==null?void 0:m.name)??"已刪除帳號"),1)]}),_:2},1024),e(p,null,{default:t(()=>[f(v(i==null?void 0:i.memo),1)]),_:2},1024),e(p,{cols:"3",class:"text-end"},{default:t(()=>[f(v(d(M)(i.amount)),1)]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1032,["onClick"])):B("",!0),T+1!=o.records.length?(V(),P(ae,{key:3,class:"border-opacity-75"})):B("",!0)],40,Tt))),128)),T+1!=N.value.length?(V(),P(ae,{key:0,class:"border-opacity-75"})):B("",!0)],64))),128))]),_:1})]),_:1}),e(kt,{accounts:d(_),onOnSave:Z,ref_key:"editRecordDialog",ref:E,onOnDelete:k},null,8,["accounts"]),e(_t,{modelValue:x.value,"onUpdate:modelValue":a[2]||(a[2]=o=>x.value=o),timeout:2e3,onClick:a[3]||(a[3]=o=>x.value=!1)},{default:t(()=>[f(v(w.value),1)]),_:1},8,["modelValue"]),e(ke,{modelValue:c.value,"onUpdate:modelValue":a[5]||(a[5]=o=>c.value=o)},{default:t(()=>[e(oe,null,{default:t(()=>[e(fe,null,{default:t(()=>[e(ce,null,{default:t(()=>[e(O,{onClick:a[4]||(a[4]=o=>ee())},{default:t(()=>a[9]||(a[9]=[f(" 刪除 ")])),_:1})]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"])],64))}});export{$t as default};
